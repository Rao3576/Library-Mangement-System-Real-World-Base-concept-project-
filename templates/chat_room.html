{% extends "base.html" %}
{% block title %}
<title>ðŸ’¬ Chat Rooms</title>
{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="text-center mb-4">ðŸ’¬ Chat Rooms</h2>

  <div class="row">
    <div class="col-md-4">
      <div class="card shadow-sm p-3 mb-4">
        <h5>Available Rooms</h5>
        <ul id="roomList" class="list-group mb-3"></ul>

        <h5>Create New Room</h5>
        <input id="roomName" class="form-control mb-2" placeholder="Enter room name">
        <input id="roomDesc" class="form-control mb-2" placeholder="Room description">
        <button class="btn btn-primary w-100" onclick="createRoom()">Create Room</button>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card shadow-sm p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 id="currentRoomTitle">Join a room to start chatting</h5>
          <input id="username" class="form-control w-25" placeholder="Your name" />
        </div>

        <textarea id="chatBox" class="form-control mb-3" rows="12" readonly></textarea>
        <div class="input-group">
          <input id="messageInput" class="form-control" placeholder="Type a message..." />
          <button class="btn btn-success" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const baseUrl = "http://127.0.0.1:8000/chat";
let ws = null;
let currentRoomId = null;

async function loadRooms() {
  console.log("[UI] loadRooms()");
  try {
    const res = await fetch(`${baseUrl}/rooms`);
    const data = await res.json();
    const list = document.getElementById("roomList");
    list.innerHTML = "";
    if (!data.rooms || data.rooms.length === 0) {
      list.innerHTML = "<li class='list-group-item text-center'>No rooms yet</li>";
      return;
    }
    data.rooms.forEach(room => {
      const li = document.createElement("li");
      li.className = "list-group-item list-group-item-action";
      li.textContent = room.name;
      li.onclick = () => joinRoom(room.id, room.name);
      list.appendChild(li);
    });
  } catch (err) {
    console.error("[UI] loadRooms error:", err);
    alert("Failed to load rooms (see console).");
  }
}

async function createRoom() {
  const name = document.getElementById("roomName").value.trim();
  const desc = document.getElementById("roomDesc").value.trim();
  if (!name) return alert("Enter room name");
  console.log("[UI] creating room:", name, desc);
  try {
    const res = await fetch(`${baseUrl}/create?name=${encodeURIComponent(name)}&description=${encodeURIComponent(desc)}`, { method: "POST" });
    if (!res.ok) {
      const err = await res.json();
      console.error("[UI] createRoom failed:", err);
      return alert(err.detail || "Failed to create room");
    }
    const result = await res.json();
    console.log("[UI] createRoom result:", result);
    document.getElementById("roomName").value = "";
    document.getElementById("roomDesc").value = "";
    loadRooms();
  } catch (err) {
    console.error("[UI] createRoom error:", err);
    alert("Error creating room (see console).");
  }
}

async function joinRoom(roomId, roomName) {
  const username = document.getElementById("username").value.trim();
  if (!username) return alert("Enter your name first");
  console.log("[UI] joinRoom", roomId, roomName, "as", username);
  currentRoomId = roomId;
  document.getElementById("currentRoomTitle").textContent = `Room: ${roomName}`;
  const chatBox = document.getElementById("chatBox");
  chatBox.value = "";

  // load messages
  try {
    const res = await fetch(`${baseUrl}/messages/${roomId}`);
    const msgs = await res.json();
    msgs.forEach(m => chatBox.value += `${m.sender}: ${m.content}\n`);
  } catch (err) {
    console.error("[UI] load messages error:", err);
  }

  // open websocket â€” NOTE the path is /ws/... because router has no prefix
  if (ws) {
    try { ws.close(); } catch {}
  }
  const wsUrl = `ws://127.0.0.1:8000/ws/${roomId}/${encodeURIComponent(username)}`;
  console.log("[UI] WS connect ->", wsUrl);
  ws = new WebSocket(wsUrl);

  ws.onopen = () => console.log("[WS] connected");
  ws.onmessage = (event) => {
    console.log("[WS] onmessage:", event.data);
    chatBox.value += event.data + "\n";
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  ws.onclose = () => console.log("[WS] closed");
  ws.onerror = (err) => console.error("[WS] error:", err);
}

function sendMessage() {
  const msg = document.getElementById("messageInput").value.trim();
  if (!msg) return;
  if (!ws || ws.readyState !== WebSocket.OPEN) return alert("Join a room first!");
  console.log("[WS] send:", msg);
  ws.send(msg);
  document.getElementById("chatBox").value += `You: ${msg}\n`;
  document.getElementById("messageInput").value = "";
}

loadRooms();
</script>
{% endblock %}

